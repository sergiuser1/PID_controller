from machine import Pin
from machine import ADC
from machine import DAC
from math import log

import machine
import utime

adc_V_lookup = [0.01235294, 0.009264706, 0.01852941, 0.02779412, 0.03705883, 0.04014706, 0.04323529, 0.04632353, 0.04941176, 0.0525, 0.05558824, 0.05867647, 0.06176471, 0.06485294, 0.06794118, 0.07102942, 0.07411765, 0.07823529, 0.08235293, 0.08647058, 0.09058824, 0.09470588, 0.09882353, 0.1012941, 0.1037647, 0.1062353, 0.1087059, 0.1111765, 0.1173529, 0.1235294, 0.1266176, 0.1297059, 0.1327941, 0.1358824, 0.1389706, 0.1420588, 0.1451471, 0.1482353, 0.1523529, 0.1564706, 0.1605882, 0.1636765, 0.1667647, 0.1698529, 0.1729412, 0.1760294, 0.1791176, 0.1822059, 0.1852941, 0.1883823, 0.1914706, 0.1945588, 0.197647, 0.2007353, 0.2038235, 0.2069118, 0.21, 0.2130882, 0.2161765, 0.2192647, 0.2223529, 0.2254412, 0.2285294, 0.2316176, 0.2347059, 0.2388235, 0.2429412, 0.2470588, 0.2501471, 0.2532353, 0.2563235, 0.2594118, 0.2625, 0.2655882, 0.2686765, 0.2717647, 0.2748529, 0.2779412, 0.2810294, 0.2841177, 0.2902941, 0.2964706, 0.3005882, 0.3047059, 0.3088235, 0.3112941, 0.3137647, 0.3162353, 0.3187058, 0.3211765, 0.3252941, 0.3294117, 0.3335294, 0.3366176, 0.3397058, 0.3427941, 0.3458823, 0.3489706, 0.3520588, 0.355147, 0.3582353, 0.3613235, 0.3644117, 0.3675, 0.3705882, 0.3736764, 0.3767647, 0.3798529, 0.3829412, 0.3860294, 0.3891176, 0.3922059, 0.3952941, 0.3994117, 0.4035294, 0.407647, 0.4117647, 0.4158823, 0.42, 0.4230882, 0.4261765, 0.4292647, 0.4323529, 0.4348235, 0.4372941, 0.4397647, 0.4422353, 0.4447059, 0.4471765, 0.449647, 0.4521176, 0.4545882, 0.4570588, 0.4611764, 0.4652941, 0.4694118, 0.4724999, 0.4755882, 0.4786764, 0.4817647, 0.4858823, 0.49, 0.4941176, 0.4982353, 0.502353, 0.5064706, 0.5105882, 0.5147059, 0.5188235, 0.5212941, 0.5237647, 0.5262352, 0.5287058, 0.5311765, 0.5342647, 0.5373529, 0.5404411, 0.5435294, 0.5466176, 0.5497059, 0.5527941, 0.5558824, 0.5599999, 0.5641176, 0.5682353, 0.5713235, 0.5744118, 0.5775, 0.5805882, 0.5836764, 0.5867647, 0.5898529, 0.5929412, 0.5960294, 0.5991177, 0.6022058, 0.6052941, 0.6094117, 0.6135294, 0.6176471, 0.6207353, 0.6238235, 0.6269117, 0.63, 0.6330882, 0.6361765, 0.6392647, 0.642353, 0.6454412, 0.6485294, 0.6516176, 0.6547059, 0.6588235, 0.6629412, 0.6670588, 0.670147, 0.6732352, 0.6763235, 0.6794117, 0.6824999, 0.6855882, 0.6886764, 0.6917646, 0.6979411, 0.7041176, 0.7065882, 0.7090588, 0.7115294, 0.714, 0.7164705, 0.7205882, 0.7247059, 0.7288235, 0.7319117, 0.7349999, 0.7380882, 0.7411764, 0.7442647, 0.7473529, 0.7504411, 0.7535294, 0.7566176, 0.7597058, 0.7627941, 0.7658823, 0.7689705, 0.7720588, 0.775147, 0.7782352, 0.7797794, 0.7813235, 0.7828676, 0.7844117, 0.7859559, 0.7875, 0.7890441, 0.7905882, 0.7936764, 0.7967647, 0.7998529, 0.8029411, 0.8070588, 0.8111764, 0.8152941, 0.8183824, 0.8214705, 0.8245588, 0.827647, 0.8307353, 0.8338235, 0.8369118, 0.84, 0.8441176, 0.8482352, 0.8523529, 0.8544117, 0.8564706, 0.8585294, 0.8605882, 0.8626471, 0.8647058, 0.8688235, 0.8729411, 0.8770588, 0.8801471, 0.8832353, 0.8863235, 0.8894117, 0.8935294, 0.897647, 0.9017647, 0.904853, 0.9079412, 0.9110294, 0.9141176, 0.9182353, 0.9223529, 0.9264706, 0.9295588, 0.9326469, 0.9357352, 0.9388235, 0.9419117, 0.9449999, 0.9480882, 0.9511765, 0.9542646, 0.9573528, 0.9604411, 0.9635294, 0.9676471, 0.9717647, 0.9758823, 0.9783528, 0.9808235, 0.9832941, 0.9857647, 0.9882353, 0.9913235, 0.9944117, 0.9974999, 1.000588, 1.003676, 1.006765, 1.009853, 1.012941, 1.017059, 1.021176, 1.025294, 1.028382, 1.031471, 1.034559, 1.037647, 1.040735, 1.043823, 1.046912, 1.05, 1.053088, 1.056176, 1.059265, 1.062353, 1.064823, 1.067294, 1.069765, 1.072235, 1.074706, 1.080882, 1.087059, 1.090147, 1.093235, 1.096323, 1.099412, 1.1025, 1.105588, 1.108676, 1.111765, 1.115882, 1.12, 1.124118, 1.127206, 1.130294, 1.133382, 1.136471, 1.139559, 1.142647, 1.145735, 1.148823, 1.152941, 1.157059, 1.161176, 1.164265, 1.167353, 1.170441, 1.173529, 1.176618, 1.179706, 1.182794, 1.185882, 1.188971, 1.192059, 1.195147, 1.198235, 1.201324, 1.204412, 1.2075, 1.210588, 1.213676, 1.216765, 1.219853, 1.222941, 1.227059, 1.231176, 1.235294, 1.238382, 1.241471, 1.244559, 1.247647, 1.250735, 1.253824, 1.256912, 1.26, 1.26247, 1.264941, 1.267412, 1.269882, 1.272353, 1.276471, 1.280588, 1.284706, 1.287794, 1.290882, 1.293971, 1.297059, 1.300147, 1.303235, 1.306324, 1.309412, 1.3125, 1.315588, 1.318676, 1.321765, 1.325882, 1.33, 1.334118, 1.337206, 1.340294, 1.343382, 1.34647, 1.349559, 1.352647, 1.355735, 1.358823, 1.361912, 1.365, 1.368088, 1.371176, 1.374265, 1.377353, 1.380441, 1.383529, 1.387647, 1.391765, 1.395882, 1.39897, 1.402059, 1.405147, 1.408235, 1.411323, 1.414412, 1.4175, 1.420588, 1.423676, 1.426765, 1.429853, 1.432941, 1.437059, 1.441176, 1.445294, 1.448382, 1.45147, 1.454559, 1.457647, 1.460735, 1.463823, 1.466912, 1.47, 1.474118, 1.478235, 1.482353, 1.485441, 1.488529, 1.491618, 1.494706, 1.497794, 1.500882, 1.503971, 1.507059, 1.510147, 1.513235, 1.516323, 1.519412, 1.523529, 1.527647, 1.531765, 1.534853, 1.537941, 1.541029, 1.544118, 1.547206, 1.550294, 1.553382, 1.55647, 1.559559, 1.562647, 1.565735, 1.568823, 1.569947, 1.571069, 1.572192, 1.573316, 1.574438, 1.575561, 1.576684, 1.577807, 1.57893, 1.580053, 1.581176, 1.584265, 1.587353, 1.590441, 1.593529, 1.597647, 1.601765, 1.605882, 1.608971, 1.612059, 1.615147, 1.618235, 1.621323, 1.624412, 1.6275, 1.630588, 1.634706, 1.638824, 1.642941, 1.646029, 1.649118, 1.652206, 1.655294, 1.657765, 1.660235, 1.662706, 1.665176, 1.667647, 1.670735, 1.673823, 1.676912, 1.68, 1.683088, 1.686176, 1.689265, 1.692353, 1.69647, 1.700588, 1.704706, 1.707794, 1.710882, 1.713971, 1.717059, 1.720147, 1.723235, 1.726324, 1.729412, 1.733529, 1.737647, 1.741765, 1.744853, 1.747941, 1.751029, 1.754118, 1.758235, 1.762353, 1.766471, 1.768941, 1.771412, 1.773882, 1.776353, 1.778823, 1.782941, 1.787059, 1.791176, 1.794265, 1.797353, 1.800441, 1.803529, 1.806618, 1.809706, 1.812794, 1.815882, 1.82, 1.824118, 1.828235, 1.831324, 1.834412, 1.8375, 1.840588, 1.843676, 1.846765, 1.849853, 1.852941, 1.856029, 1.859118, 1.862206, 1.865294, 1.869412, 1.873529, 1.877647, 1.881765, 1.885882, 1.89, 1.893088, 1.896176, 1.899265, 1.902353, 1.904823, 1.907294, 1.909765, 1.912235, 1.914706, 1.918823, 1.922941, 1.927059, 1.930147, 1.933235, 1.936323, 1.939412, 1.943529, 1.947647, 1.951765, 1.954853, 1.957941, 1.961029, 1.964118, 1.967206, 1.970294, 1.973382, 1.97647, 1.979559, 1.982647, 1.985735, 1.988823, 1.992941, 1.997059, 2.001176, 2.004265, 2.007353, 2.010441, 2.013529, 2.017647, 2.021765, 2.025882, 2.02897, 2.032059, 2.035147, 2.038235, 2.041323, 2.044412, 2.0475, 2.050588, 2.053676, 2.056765, 2.059853, 2.062941, 2.067059, 2.071177, 2.075294, 2.078382, 2.08147, 2.084559, 2.087647, 2.090117, 2.092588, 2.095059, 2.097529, 2.1, 2.103088, 2.106176, 2.109265, 2.112353, 2.11647, 2.120588, 2.124706, 2.127794, 2.130882, 2.13397, 2.137059, 2.140147, 2.143235, 2.146323, 2.149412, 2.153529, 2.157647, 2.161765, 2.164235, 2.166706, 2.169176, 2.171647, 2.174118, 2.177206, 2.180294, 2.183382, 2.186471, 2.190588, 2.194706, 2.198823, 2.201912, 2.205, 2.208088, 2.211176, 2.214265, 2.217353, 2.220441, 2.223529, 2.227647, 2.231765, 2.235882, 2.238971, 2.242059, 2.245147, 2.248235, 2.251323, 2.254412, 2.2575, 2.260588, 2.264706, 2.268823, 2.272941, 2.276029, 2.279118, 2.282206, 2.285294, 2.289412, 2.293529, 2.297647, 2.300117, 2.302588, 2.305059, 2.307529, 2.31, 2.314117, 2.318235, 2.322353, 2.324823, 2.327294, 2.329765, 2.332235, 2.334706, 2.338823, 2.342941, 2.347059, 2.349529, 2.352, 2.35447, 2.356941, 2.359412, 2.360956, 2.3625, 2.364044, 2.365588, 2.367132, 2.368676, 2.37022, 2.371765, 2.374853, 2.377941, 2.381029, 2.384118, 2.387206, 2.390294, 2.393382, 2.396471, 2.400588, 2.404706, 2.408823, 2.411294, 2.413764, 2.416235, 2.418706, 2.421176, 2.425294, 2.429412, 2.433529, 2.436618, 2.439706, 2.442794, 2.445882, 2.448971, 2.452059, 2.455147, 2.458235, 2.461323, 2.464412, 2.4675, 2.470588, 2.474706, 2.478823, 2.482941, 2.485, 2.487059, 2.489118, 2.491176, 2.493235, 2.495294, 2.498382, 2.501471, 2.504559, 2.507647, 2.510735, 2.513824, 2.516912, 2.52, 2.523088, 2.526176, 2.529265, 2.532353, 2.535441, 2.538529, 2.541618, 2.544706, 2.547794, 2.550882, 2.553971, 2.557059, 2.559529, 2.562, 2.564471, 2.566941, 2.569412, 2.573529, 2.577647, 2.581765, 2.584853, 2.587941, 2.591029, 2.594118, 2.596176, 2.598235, 2.600294, 2.602353, 2.604412, 2.606471, 2.609559, 2.612647, 2.615735, 2.618824, 2.621912, 2.625, 2.628088, 2.631176, 2.634265, 2.637353, 2.640441, 2.643529, 2.646617, 2.649706, 2.652794, 2.655882, 2.65897, 2.662059, 2.665147, 2.668235, 2.670706, 2.673176, 2.675647, 2.678118, 2.680588, 2.683676, 2.686764, 2.689853, 2.692941, 2.696029, 2.699117, 2.702206, 2.705294, 2.707765, 2.710235, 2.712706, 2.715176, 2.717647, 2.720118, 2.722588, 2.725059, 2.727529, 2.73, 2.732471, 2.734941, 2.737412, 2.739882, 2.742353, 2.745441, 2.748529, 2.751617, 2.754706, 2.757176, 2.759647, 2.762118, 2.764588, 2.767059, 2.769529, 2.772, 2.774471, 2.776941, 2.779412, 2.781882, 2.784353, 2.786824, 2.789294, 2.791764, 2.793823, 2.795882, 2.797941, 2.8, 2.802059, 2.804117, 2.807206, 2.810294, 2.813382, 2.81647, 2.818529, 2.820588, 2.822647, 2.824706, 2.826765, 2.828823, 2.831294, 2.833765, 2.836235, 2.838706, 2.841176, 2.842941, 2.844706, 2.846471, 2.848235, 2.85, 2.851765, 2.853529, 2.856617, 2.859706, 2.862794, 2.865882, 2.867941, 2.87, 2.872059, 2.874118, 2.876176, 2.878235, 2.880706, 2.883176, 2.885647, 2.888118, 2.890588, 2.892647, 2.894706, 2.896765, 2.898824, 2.900882, 2.902941, 2.905, 2.907059, 2.909118, 2.911176, 2.913235, 2.915294, 2.917353, 2.919412, 2.92147, 2.923529, 2.925588, 2.927647, 2.930117, 2.932588, 2.935059, 2.937529, 2.94, 2.942059, 2.944118, 2.946176, 2.948235, 2.950294, 2.952353, 2.954118, 2.955882, 2.957647, 2.959412, 2.961176, 2.962941, 2.964706, 2.966765, 2.968823, 2.970882, 2.972941, 2.975, 2.977059, 2.979118, 2.981176, 2.983235, 2.985294, 2.987353, 2.989412, 2.991176, 2.992941, 2.994706, 2.99647, 2.998235, 3.0, 3.001765, 3.003824, 3.005882, 3.007941, 3.01, 3.012059, 3.014117, 3.015662, 3.017206, 3.01875, 3.020294, 3.021838, 3.023382, 3.024926, 3.02647, 3.028529, 3.030588, 3.032647, 3.034706, 3.036765, 3.038823, 3.040882, 3.042941, 3.045, 3.047059, 3.049118, 3.051176, 3.053235, 3.055294, 3.057353, 3.059412, 3.06147, 3.063529, 3.065588, 3.067647, 3.069706, 3.071765, 3.073823, 3.075882, 3.077426, 3.07897, 3.080515, 3.082059, 3.083603, 3.085147, 3.086691, 3.088235, 3.094412, 3.125294]

NOM_RES = 10000
SER_RES =  9950
TEMP_NOM = 25
NUM_SAMPLES = 25
THERM_B_COEFF = 3950
ADC_MAX = 1023
ADC_Vmax = 3.15

def init_temp_sensor(TENP_SENS_ADC_PIN_NO = 39):
    adc = ADC(Pin(TENP_SENS_ADC_PIN_NO))
    adc.atten(ADC.ATTN_11DB)
    adc.width(ADC.WIDTH_10BIT)
    return adc

def read_temp(temp_sens):
    raw_read = []
    # Collect NUM_SAMPLES
    for i in range(1, NUM_SAMPLES+1):
        raw_read.append(temp_sens.read())

    # Average of the NUM_SAMPLES and look it up in the table
    raw_average = sum(raw_read)/NUM_SAMPLES
    print('raw_avg = ' + str(raw_average))
    print('V_measured = ' + str(adc_V_lookup[round(raw_average)]))

    # Convert to resistance
    raw_average = ADC_MAX * adc_V_lookup[round(raw_average)]/ADC_Vmax
    resistance = (SER_RES * raw_average) / (ADC_MAX - raw_average)
    print('Thermistor resistance: {} ohms'.format(resistance))

    # Convert to temperature
    steinhart  = log(resistance / NOM_RES) / THERM_B_COEFF
    steinhart += 1.0 / (TEMP_NOM + 273.15)
    steinhart  = (1.0 / steinhart) - 273.15
    return steinhart

print("I'm alive!\n")
utime.sleep_ms(2000)

temp_sens = init_temp_sensor()

sample_last_ms = 0
SAMPLE_INTERVAL = 1000

while (True):
    if utime.ticks_diff(utime.ticks_ms(), sample_last_ms) >= SAMPLE_INTERVAL:
        temp = read_temp(temp_sens)
        print('Thermistor temperature: ' + str(temp))
        sample_last_ms = utime.ticks_ms()
